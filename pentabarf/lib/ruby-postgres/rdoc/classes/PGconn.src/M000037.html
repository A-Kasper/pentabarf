<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>insert_table (PGconn)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre>/*
 * call-seq:
 *    conn.insert_table( table, values )
 *
 * Inserts contents of the _values_ Array into the _table_.
 */
static VALUE
pgconn_insert_table(obj, table, values)
    VALUE obj, table, values;
{
    PGconn *conn = get_pgconn(obj);
    PGresult *result;
    VALUE s, buffer;
    int i, j;
    int res = 0;

    Check_Type(table, T_STRING);
    Check_Type(values, T_ARRAY);
    i = RARRAY(values)-&gt;len;
    while (i--) {
        if (TYPE(RARRAY(RARRAY(values)-&gt;ptr[i])) != T_ARRAY) {
            rb_raise(rb_ePGError, &quot;second arg must contain some kind of arrays.&quot;);
        }
    }
    
    buffer = rb_str_new(0, RSTRING(table)-&gt;len + 17 + 1);
    /* starts query */
    snprintf(RSTRING(buffer)-&gt;ptr, RSTRING(buffer)-&gt;len, &quot;copy %s from stdin &quot;, StringValuePtr(table));
    
    result = PQexec(conn, StringValuePtr(buffer));
    if (!result){
        rb_raise(rb_ePGError, PQerrorMessage(conn));
    }
    PQclear(result);

    for (i = 0; i &lt; RARRAY(values)-&gt;len; i++) {
        struct RArray *row = RARRAY(RARRAY(values)-&gt;ptr[i]);
        buffer = rb_tainted_str_new(0,0);
        for (j = 0; j &lt; row-&gt;len; j++) {
            if (j &gt; 0) rb_str_cat(buffer, &quot;\t&quot;, 1);
            if (NIL_P(row-&gt;ptr[j])) {
                rb_str_cat(buffer, &quot;\\N&quot;,2);
            } else {
                s = rb_obj_as_string(row-&gt;ptr[j]);
                rb_funcall(s,pg_gsub_bang_id,2,pg_escape_regex,pg_escape_str);
                rb_str_cat(buffer, StringValuePtr(s), RSTRING(s)-&gt;len);
            }
        }
        rb_str_cat(buffer, &quot;\n\0&quot;, 2);
        /* sends data */
        PQputline(conn, StringValuePtr(buffer));
    }
    PQputline(conn, &quot;\\.\n&quot;);
    res = PQendcopy(conn);

    return obj;
}</pre>
</body>
</html>